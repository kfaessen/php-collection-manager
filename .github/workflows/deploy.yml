name: üöÄ OVH Optimized Multi-Environment Deploy

on:
  push:
    branches:
      - main           # Multi-environment deployment pipeline
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

env:
  PHP_VERSION: '8.4'
  COMPOSER_CACHE_DIR: ~/.composer/cache

jobs:
  # Pre-deployment validation and testing
  validate:
    name: üîç Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      skip_tests: ${{ steps.determine-env.outputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo, pdo_mysql, mbstring, openssl, curl, json
          coverage: none

      - name: Validate composer.json
        run: composer validate --strict

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ env.COMPOSER_CACHE_DIR }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: PHP Syntax Check
        run: find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;

      - name: Security Audit
        run: composer audit 2>/dev/null || echo "No security vulnerabilities found"

      - name: Determine deployment environment
        id: determine-env
        run: |
          case "${{ github.ref_name }}" in
            "main") 
              echo "environment=production" >> $GITHUB_OUTPUT
              echo "skip_tests=false" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "environment=none" >> $GITHUB_OUTPUT
              echo "skip_tests=true" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Database Migration Dry Run
        if: steps.determine-env.outputs.environment != 'none'
        run: |
          echo "üîç Checking database migration scripts..."
          if [ -f "includes/Database.php" ]; then
            php -l includes/Database.php
            echo "‚úÖ Database migration scripts are valid"
          fi

  deploy-dev:
    name: üöÄ Deploy to Development
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref_name == 'main' && github.event_name != 'pull_request'
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment variables
        id: setup
        run: |
          echo "backup_suffix=dev_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "environment=development" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create backup
        run: |
          echo "üíæ Creating backup: ${{ steps.setup.outputs.backup_suffix }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            if [ ! -d ../backups ]; then mkdir -p ../backups; fi
            tar -czf ../backups/backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz \
              --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='*.log' .
            echo '‚úÖ Backup created: backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz'
          "

      - name: Deploy application
        run: |
          echo "üöÄ Deploying to ${{ steps.setup.outputs.environment }}..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Install/update dependencies
            if command -v composer &> /dev/null; then
              composer install --no-dev --optimize-autoloader --no-interaction
            else
              echo '‚ö†Ô∏è  Composer not found, skipping dependency installation'
            fi
            
            # Set correct file permissions for OVH
            find . -type f -name '*.php' -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            
            # Ensure uploads directory exists and is writable
            mkdir -p uploads/covers
            chmod -R 755 uploads/
            
            # Set cache directories if they exist
            if [ -d 'cache' ]; then chmod -R 755 cache/; fi
            if [ -d 'logs' ]; then chmod -R 755 logs/; fi
            
            echo '‚úÖ Application deployed successfully'
          "

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Check if migration script exists and run it
            if [ -f 'run_migrations.php' ]; then
              php run_migrations.php 2>&1 || {
                echo '‚ùå Database migration failed'
                exit 1
              }
              echo '‚úÖ Database migrations completed'
            else
              echo '‚ö†Ô∏è  No migration script found, skipping database updates'
            fi
          "

      - name: Cleanup old backups
        run: |
          echo "üßπ Cleaning up old backups..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/../backups 2>/dev/null || exit 0
            
            # Keep only the last 5 backups per environment
            ENV_PREFIX=$(echo '${{ steps.setup.outputs.environment }}' | cut -c1-3)
            ls -t backup_${ENV_PREFIX}_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f
            
            echo '‚úÖ Backup cleanup completed'
          " || echo "No backups to clean up"

      - name: Deploy summary
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY

  deploy-tst:
    name: üöÄ Deploy to Test
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref_name == 'main' && github.event_name != 'pull_request'
    environment:
      name: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment variables
        id: setup
        run: |
          echo "backup_suffix=tst_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "environment=test" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create backup
        run: |
          echo "üíæ Creating backup: ${{ steps.setup.outputs.backup_suffix }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            if [ ! -d ../backups ]; then mkdir -p ../backups; fi
            tar -czf ../backups/backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz \
              --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='*.log' .
            echo '‚úÖ Backup created: backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz'
          "

      - name: Deploy application
        run: |
          echo "üöÄ Deploying to ${{ steps.setup.outputs.environment }}..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Install/update dependencies
            if command -v composer &> /dev/null; then
              composer install --no-dev --optimize-autoloader --no-interaction
            else
              echo '‚ö†Ô∏è  Composer not found, skipping dependency installation'
            fi
            
            # Set correct file permissions for OVH
            find . -type f -name '*.php' -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            
            # Ensure uploads directory exists and is writable
            mkdir -p uploads/covers
            chmod -R 755 uploads/
            
            # Set cache directories if they exist
            if [ -d 'cache' ]; then chmod -R 755 cache/; fi
            if [ -d 'logs' ]; then chmod -R 755 logs/; fi
            
            echo '‚úÖ Application deployed successfully'
          "

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Check if migration script exists and run it
            if [ -f 'run_migrations.php' ]; then
              php run_migrations.php 2>&1 || {
                echo '‚ùå Database migration failed'
                exit 1
              }
              echo '‚úÖ Database migrations completed'
            else
              echo '‚ö†Ô∏è  No migration script found, skipping database updates'
            fi
          "

      - name: Cleanup old backups
        run: |
          echo "üßπ Cleaning up old backups..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/../backups 2>/dev/null || exit 0
            
            # Keep only the last 5 backups per environment
            ENV_PREFIX=$(echo '${{ steps.setup.outputs.environment }}' | cut -c1-3)
            ls -t backup_${ENV_PREFIX}_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f
            
            echo '‚úÖ Backup cleanup completed'
          " || echo "No backups to clean up"

      - name: Deploy summary
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY

  deploy-acc:
    name: üöÄ Deploy to Acceptance
    runs-on: ubuntu-latest
    needs: deploy-tst
    if: github.ref_name == 'main' && github.event_name != 'pull_request'
    environment:
      name: acceptance
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment variables
        id: setup
        run: |
          echo "backup_suffix=acc_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "environment=acceptance" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create backup
        run: |
          echo "üíæ Creating backup: ${{ steps.setup.outputs.backup_suffix }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            if [ ! -d ../backups ]; then mkdir -p ../backups; fi
            tar -czf ../backups/backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz \
              --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='*.log' .
            echo '‚úÖ Backup created: backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz'
          "

      - name: Deploy application
        run: |
          echo "üöÄ Deploying to ${{ steps.setup.outputs.environment }}..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Install/update dependencies
            if command -v composer &> /dev/null; then
              composer install --no-dev --optimize-autoloader --no-interaction
            else
              echo '‚ö†Ô∏è  Composer not found, skipping dependency installation'
            fi
            
            # Set correct file permissions for OVH
            find . -type f -name '*.php' -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            
            # Ensure uploads directory exists and is writable
            mkdir -p uploads/covers
            chmod -R 755 uploads/
            
            # Set cache directories if they exist
            if [ -d 'cache' ]; then chmod -R 755 cache/; fi
            if [ -d 'logs' ]; then chmod -R 755 logs/; fi
            
            echo '‚úÖ Application deployed successfully'
          "

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Check if migration script exists and run it
            if [ -f 'run_migrations.php' ]; then
              php run_migrations.php 2>&1 || {
                echo '‚ùå Database migration failed'
                exit 1
              }
              echo '‚úÖ Database migrations completed'
            else
              echo '‚ö†Ô∏è  No migration script found, skipping database updates'
            fi
          "

      - name: Cleanup old backups
        run: |
          echo "üßπ Cleaning up old backups..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/../backups 2>/dev/null || exit 0
            
            # Keep only the last 5 backups per environment
            ENV_PREFIX=$(echo '${{ steps.setup.outputs.environment }}' | cut -c1-3)
            ls -t backup_${ENV_PREFIX}_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f
            
            echo '‚úÖ Backup cleanup completed'
          " || echo "No backups to clean up"

      - name: Deploy summary
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY

  deploy-prd:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-acc
    if: github.ref_name == 'main' && github.event_name != 'pull_request'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup deployment variables
        id: setup
        run: |
          echo "backup_suffix=prod_$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create maintenance mode
        run: |
          echo "üöß Enabling maintenance mode for production..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            echo '<?php http_response_code(503); echo \"<h1>Onderhoud</h1><p>De site wordt bijgewerkt. Probeer het over een paar minuten opnieuw.</p>\"; exit; ?>' > maintenance.php
            if [ -f .htaccess ]; then cp .htaccess .htaccess.backup; fi
            echo 'RewriteEngine On
            RewriteCond %{REQUEST_URI} !^/maintenance\.php$
            RewriteCond %{REMOTE_ADDR} !^${{ secrets.ADMIN_IP }}$
            RewriteRule ^(.*)$ /maintenance.php [R=503,L]' > .htaccess
          "

      - name: Create backup
        run: |
          echo "üíæ Creating backup: ${{ steps.setup.outputs.backup_suffix }}"
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            if [ ! -d ../backups ]; then mkdir -p ../backups; fi
            tar -czf ../backups/backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz \
              --exclude='.git' --exclude='vendor' --exclude='uploads' --exclude='*.log' .
            echo '‚úÖ Backup created: backup_${{ steps.setup.outputs.backup_suffix }}.tar.gz'
          "

      - name: Deploy application
        run: |
          echo "üöÄ Deploying to ${{ steps.setup.outputs.environment }}..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Pull latest changes
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
            
            # Install/update dependencies
            if command -v composer &> /dev/null; then
              composer install --no-dev --optimize-autoloader --no-interaction
            else
              echo '‚ö†Ô∏è  Composer not found, skipping dependency installation'
            fi
            
            # Set correct file permissions for OVH
            find . -type f -name '*.php' -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            
            # Ensure uploads directory exists and is writable
            mkdir -p uploads/covers
            chmod -R 755 uploads/
            
            # Set cache directories if they exist
            if [ -d 'cache' ]; then chmod -R 755 cache/; fi
            if [ -d 'logs' ]; then chmod -R 755 logs/; fi
            
            echo '‚úÖ Application deployed successfully'
          "

      - name: Run database migrations
        run: |
          echo "üóÑÔ∏è  Running database migrations..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Check if migration script exists and run it
            if [ -f 'run_migrations.php' ]; then
              php run_migrations.php 2>&1 || {
                echo '‚ùå Database migration failed'
                exit 1
              }
              echo '‚úÖ Database migrations completed'
            else
              echo '‚ö†Ô∏è  No migration script found, skipping database updates'
            fi
          "

      - name: Disable maintenance mode
        run: |
          echo "üîÑ Disabling maintenance mode..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}
            rm -f maintenance.php
            if [ -f .htaccess.backup ]; then 
              mv .htaccess.backup .htaccess
            else
              rm -f .htaccess
            fi
          "

      - name: Cleanup old backups
        run: |
          echo "üßπ Cleaning up old backups..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd ${{ secrets.DEPLOY_PATH }}/../backups 2>/dev/null || exit 0
            
            # Keep only the last 5 backups per environment
            ENV_PREFIX=$(echo '${{ steps.setup.outputs.environment }}' | cut -c1-3)
            ls -t backup_${ENV_PREFIX}_*.tar.gz 2>/dev/null | tail -n +6 | xargs rm -f
            
            echo '‚úÖ Backup cleanup completed'
          " || echo "No backups to clean up"

      - name: Deploy summary
        run: |
          echo "## üéâ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ‚úÖ Success" >> $GITHUB_STEP_SUMMARY

  # Notification job (runs regardless of deployment success/failure)
  notify:
    name: üì¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [validate, deploy-prd]
    if: always() && needs.validate.outputs.environment != 'none' && github.event_name != 'pull_request'
    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy-prd.result }}" == "success" ]; then
            echo "‚úÖ Deployment to production completed successfully"
          else
            echo "‚ùå Deployment to production failed"
          fi 